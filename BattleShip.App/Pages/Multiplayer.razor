@page "/multiplayer"
@page "/multiplayer/{gameId?}"
@using BattleShip.Models
@using BattleShip.App.Services
@using BattleShip.App.Components
@using Microsoft.AspNetCore.Components
@inject MultiplayerGameClient MultiplayerService
@inject NavigationManager Navigation
@implements IDisposable

<div class="multiplayer-container">
    @if (CurrentPhase == GamePhase.Lobby)
    {
        <div class="lobby">
            <h1>Mode Multijoueur</h1>
            <div class="lobby-form">
                <label>Votre nom:</label>
                <input type="text" @bind="PlayerName" placeholder="Entrez votre nom" />
                <button class="join-button" @onclick="JoinGame" disabled="@string.IsNullOrWhiteSpace(PlayerName)">
                    Rejoindre une partie
                </button>
                <button class="back-button" @onclick="GoBack">
                    Retour
                </button>
            </div>
        </div>
    }
    else if (CurrentPhase == GamePhase.WaitingForOpponent)
    {
        <div class="waiting">
            <h2>En attente d'un adversaire...</h2>
            <div class="spinner"></div>
            <button class="cancel-button" @onclick="CancelWaiting">Annuler</button>
        </div>
    }
    else if (CurrentPhase == GamePhase.Placement)
    {
        <div class="placement-phase">
            <h2>Placez vos bateaux</h2>
            @if (!string.IsNullOrEmpty(OpponentName))
            {
                <p>Adversaire: <strong>@OpponentName</strong></p>
            }
            @if (OpponentReady)
            {
                <p class="opponent-status">‚úì Votre adversaire est pr√™t</p>
            }
            <ShipPlacementUI OnPlacementsConfirmed="OnShipsPlaced" />
        </div>
    }
    else if (CurrentPhase == GamePhase.Playing)
    {
        <GamePopup 
            IsVisible="CurrentPhase == GamePhase.GameOver"
            IsVictory="IsVictory"
            OnRestart="StartNewGame"
            OnBackToMenu="GoBack" />

        <div class="game-container">
            <div class="game-info">
                <div class="player-info">
                    <p><strong>@(MultiplayerService.PlayerName ?? "Vous")</strong> vs <strong>@OpponentName</strong></p>
                    <p class="turn-indicator @(IsMyTurn ? "my-turn" : "opponent-turn")">
                        @(IsMyTurn ? "üéØ C'est votre tour" : "‚è≥ Tour de l'adversaire")
                    </p>
                </div>
                <button class="game-btn leave-button" @onclick="LeaveGame">Quitter</button>
            </div>

            <div class="boards-container">
                <div class="board-section">
                    <h3 class="board-title player-title">Votre Grille</h3>
                    <div class="board-wrapper">
                        <GameBoard 
                            BoardData="MultiplayerService.MyBoard?.Grid"
                            GridSize="@(MultiplayerService.MyBoard?.Grid?.GetLength(0) ?? 10)"
                            IsOpponentBoard="false" />
                    </div>
                </div>

                <div class="board-section">
                    <h3 class="board-title opponent-title">Grille Adverse</h3>
                    <div class="board-wrapper">
                        <GameBoard 
                            BoardData="MultiplayerService.OpponentBoard?.Grid"
                            GridSize="@(MultiplayerService.OpponentBoard?.Grid?.GetLength(0) ?? 10)"
                            IsOpponentBoard="true"
                            IsClickable="IsMyTurn && CurrentPhase == GamePhase.Playing"
                            OnCellClick="HandleAttackClick" />
                    </div>
                </div>
            </div>

            @if (MultiplayerService.History.Count > 0)
            {
                <div class="history-section">
                    <AttackHistoryList 
                        History="MultiplayerService.History"
                        Title="Historique des coups"
                        MaxItems="50"
                        PlayerName="@(MultiplayerService.PlayerName ?? "Vous")"
                        OpponentName="@OpponentName" />
                </div>
            }
        </div>
    }

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="message-box @MessageClass">
            @Message
        </div>
    }
</div>

@code {
    [Parameter] public string? GameId { get; set; }

    private enum GamePhase
    {
        Lobby,
        WaitingForOpponent,
        Placement,
        Playing,
        GameOver
    }

    private GamePhase CurrentPhase { get; set; } = GamePhase.Lobby;
    private string PlayerName { get; set; } = "";
    private string? OpponentName { get; set; }
    private bool OpponentReady { get; set; }
    private bool IsMyTurn { get; set; }
    private bool IsVictory { get; set; }
    private string Message { get; set; } = "";
    private string MessageClass { get; set; } = "";
    private string GameOverMessage { get; set; } = "";

    private bool _isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        MultiplayerService.OnWaitingForOpponent += HandleWaitingForOpponent;
        MultiplayerService.OnGameJoined += HandleGameJoined;
        MultiplayerService.OnOpponentJoined += HandleOpponentJoined;
        MultiplayerService.OnOpponentReady += HandleOpponentReady;
        MultiplayerService.OnGameStarted += HandleGameStarted;
        MultiplayerService.OnAttackResult += HandleAttackResult;
        MultiplayerService.OnOpponentAttacked += HandleOpponentAttacked;
        MultiplayerService.OnYourTurn += HandleYourTurn;
        MultiplayerService.OnGameWon += HandleGameWon;
        MultiplayerService.OnGameLost += HandleGameLost;
        MultiplayerService.OnOpponentDisconnected += HandleOpponentDisconnected;
        
        // Si on a un GameId dans l'URL, essayer de restaurer
        if (!string.IsNullOrEmpty(GameId))
        {
            PlayerName = await MultiplayerService.GetStoredPlayerNameAsync() ?? "Joueur";
            if (!string.IsNullOrEmpty(PlayerName))
            {
                CurrentPhase = GamePhase.WaitingForOpponent;
                Message = "Reconnexion en cours...";
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;
            await MultiplayerService.InitializeAsync();
            
            // Essayer de restaurer un jeu sauvegard√©
            var gameRestored = await MultiplayerService.TryRestoreGameAsync();
            if (gameRestored)
            {
                RestoreGameState();
            }
            
            StateHasChanged();
        }
    }

    private void RestoreGameState()
    {
        if (!string.IsNullOrEmpty(MultiplayerService.OpponentName))
        {
            OpponentName = MultiplayerService.OpponentName;
            
            if (MultiplayerService.MyBoard != null && MultiplayerService.OpponentBoard != null)
            {
                CurrentPhase = GamePhase.Playing;
                IsMyTurn = MultiplayerService.IsMyTurn;
                Message = IsMyTurn ? "Partie restaur√©e - C'est votre tour" : "Partie restaur√©e - Tour de l'adversaire";
            }
            else if (MultiplayerService.MyBoard != null)
            {
                CurrentPhase = GamePhase.Placement;
                Message = "En attente de l'adversaire...";
            }
            else
            {
                CurrentPhase = GamePhase.Placement;
                Message = "Placez vos bateaux";
            }
        }
        
        StateHasChanged();
    }

    private async Task JoinGame()
    {
        CurrentPhase = GamePhase.WaitingForOpponent;
        await MultiplayerService.JoinGameAsync(PlayerName);
    }

    private void HandleWaitingForOpponent(string message)
    {
        Message = message;
        StateHasChanged();
    }

    private void HandleGameJoined(string gameId, string opponentName)
    {
        OpponentName = opponentName;
        CurrentPhase = GamePhase.Placement;
        Message = $"Adversaire trouv√©: {opponentName}";
        
        // Naviguer vers l'URL avec le GameId pour la persistance
        Navigation.NavigateTo($"/multiplayer/{gameId}", replace: true);
        StateHasChanged();
    }

    private void HandleOpponentJoined(string gameId, string opponentName)
    {
        OpponentName = opponentName;
        CurrentPhase = GamePhase.Placement;
        Message = $"Adversaire trouv√©: {opponentName}";
        
        // Naviguer vers l'URL avec le GameId pour la persistance
        Navigation.NavigateTo($"/multiplayer/{gameId}", replace: true);
        StateHasChanged();
    }

    private void HandleOpponentReady()
    {
        OpponentReady = true;
        Message = "Votre adversaire est pr√™t";
        StateHasChanged();
    }

    private void HandleGameStarted(string currentTurnPlayerId)
    {
        CurrentPhase = GamePhase.Playing;
        IsMyTurn = MultiplayerService.IsMyTurn;
        Message = IsMyTurn ? "La partie commence ! C'est votre tour" : "La partie commence ! Tour de l'adversaire";
        StateHasChanged();
    }

    private async Task OnShipsPlaced(List<BattleShip.Models.ShipPlacement> placements)
    {
        await MultiplayerService.PlaceShipsAsync(placements);
        Message = "En attente de l'adversaire...";
        StateHasChanged();
    }

    private async Task Attack(int x, int y)
    {
        if (!IsMyTurn || CurrentPhase != GamePhase.Playing) return;

        var cell = MultiplayerService.OpponentBoard?.Grid[x, y];
        if (cell?.IsHit == true) return;

        try
        {
            await MultiplayerService.AttackAsync(x, y);
        }
        catch (Exception ex)
        {
            Message = $"Erreur: {ex.Message}";
            MessageClass = "error";
            StateHasChanged();
        }
    }
    
    private async Task HandleAttackClick((int x, int y) coords)
    {
        await Attack(coords.x, coords.y);
    }

    private void HandleAttackResult(int x, int y, bool hit, bool sunk, bool gameOver)
    {
        IsMyTurn = MultiplayerService.IsMyTurn;
        
        if (gameOver)
        {
            return;
        }

        if (hit)
        {
            Message = sunk ? "Touch√©-Coul√© !" : "Touch√© !";
            MessageClass = "success";
        }
        else
        {
            Message = "Rat√©";
            MessageClass = "info";
        }
        
        StateHasChanged();
    }

    private void HandleOpponentAttacked(int x, int y, bool hit, bool sunk, bool gameOver)
    {
        if (gameOver)
        {
            // Will be handled by OnGameLost
            return;
        }

        if (hit)
        {
            Message = sunk ? "L'adversaire a coul√© votre bateau !" : "L'adversaire a touch√© votre bateau";
            MessageClass = "warning";
        }
        else
        {
            Message = "L'adversaire a rat√©";
            MessageClass = "info";
        }
        
        StateHasChanged();
    }

    private void HandleYourTurn()
    {
        IsMyTurn = true;
        Message = "C'est votre tour !";
        MessageClass = "info";
        StateHasChanged();
    }

    private void HandleGameWon()
    {
        CurrentPhase = GamePhase.GameOver;
        IsVictory = true;
        GameOverMessage = "üéâ Victoire ! Vous avez gagn√© !";
        StateHasChanged();
    }

    private void HandleGameLost()
    {
        CurrentPhase = GamePhase.GameOver;
        IsVictory = false;
        GameOverMessage = "üò¢ D√©faite ! Vous avez perdu.";
        StateHasChanged();
    }

    private void HandleOpponentDisconnected()
    {
        Message = "L'adversaire s'est d√©connect√©";
        MessageClass = "error";
        CurrentPhase = GamePhase.GameOver;
        IsVictory = false;
        GameOverMessage = "L'adversaire s'est d√©connect√©";
        StateHasChanged();
    }

    private async Task CancelWaiting()
    {
        await MultiplayerService.DisconnectAsync();
        CurrentPhase = GamePhase.Lobby;
        Message = "";
        StateHasChanged();
    }

    private async Task LeaveGame()
    {
        await MultiplayerService.DisconnectAsync();
        Navigation.NavigateTo("/");
    }

    private async Task StartNewGame()
    {
        await MultiplayerService.DisconnectAsync();
        CurrentPhase = GamePhase.Lobby;
        OpponentName = null;
        OpponentReady = false;
        IsVictory = false;
        Message = "";
        GameOverMessage = "";
        PlayerName = "";
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }



    public void Dispose()
    {
        MultiplayerService.OnWaitingForOpponent -= HandleWaitingForOpponent;
        MultiplayerService.OnGameJoined -= HandleGameJoined;
        MultiplayerService.OnOpponentJoined -= HandleOpponentJoined;
        MultiplayerService.OnOpponentReady -= HandleOpponentReady;
        MultiplayerService.OnGameStarted -= HandleGameStarted;
        MultiplayerService.OnAttackResult -= HandleAttackResult;
        MultiplayerService.OnOpponentAttacked -= HandleOpponentAttacked;
        MultiplayerService.OnYourTurn -= HandleYourTurn;
        MultiplayerService.OnGameWon -= HandleGameWon;
        MultiplayerService.OnGameLost -= HandleGameLost;
        MultiplayerService.OnOpponentDisconnected -= HandleOpponentDisconnected;
    }
}

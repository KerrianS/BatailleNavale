@using BattleShip.Models
@inject IJSRuntime JSRuntime

<div class="ship-placement-container">
    <div class="placement-controls-section">
        <div class="grid-size-selector-inline">
            <button class="size-btn-inline @(GridSize == 10 ? "active" : "")" @onclick="() => ChangeSize(10)">10x10</button>
            <button class="size-btn-inline @(GridSize == 15 ? "active" : "")" @onclick="() => ChangeSize(15)">15x15</button>
            <button class="size-btn-inline @(GridSize == 20 ? "active" : "")" @onclick="() => ChangeSize(20)">20x20</button>
        </div>

        <div class="ship-selection">
            @foreach (var ship in RemainingShips)
            {
                var isSelected = SelectedShipType.HasValue && SelectedShipType.Value == ship.Type;
                var currentShip = ship;
                <button class="ship-button @(isSelected ? "selected" : "")" 
                        @onclick="() => SelectShip(currentShip)"
                        @onclick:stopPropagation="true">
                    @ship.Name
                </button>
            }
        </div>

        <div class="placement-controls">
            <button class="orientation-button" @onclick="ToggleOrientation">
                Orientation: @(IsHorizontal ? "Horizontale" : "Verticale")
            </button>
        </div>

        @if (RemainingShips.Count == 0)
        {
            <button class="ready-button" @onclick="OnConfirmPlacement">
                Confirmer le placement
            </button>
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="error-message">@ErrorMessage</div>
        }
    </div>

    <div class="placement-grid-section">
        <GameBoard 
            BoardData="PlacementBoard.Grid"
            GridSize="@GridSize"
            IsOpponentBoard="false"
            IsClickable="true"
            OnCellClick="HandlePlacementClick"
            OnCellRightClick="HandleRightClick"
            OnCellHover="HandleCellHoverEvent"
            OnCellLeave="ClearHover"
            GetCustomCellClass="GetPlacementCellClass"
            RowClassName="grid-row" />
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<List<ShipPlacement>> OnPlacementsConfirmed { get; set; }

    [Parameter]
    public int GridSize { get; set; } = 10;

    [Parameter]
    public EventCallback<int> OnGridSizeChanged { get; set; }

    private Board PlacementBoard { get; set; } = new Board();
    private List<ShipPlacement> Placements { get; set; } = new();
    private List<ShipInfo> RemainingShips { get; set; } = new();
    private ShipType? SelectedShipType { get; set; } = null;
    private bool IsHorizontal { get; set; } = true;
    private int HoverX { get; set; } = -1;
    private int HoverY { get; set; } = -1;
    private string ErrorMessage { get; set; } = "";

    private class ShipInfo
    {
        public string Name { get; set; } = "";
        public int Size { get; set; }
        public ShipType Type { get; set; }
    }

    protected override void OnInitialized()
    {
        PlacementBoard = new Board(GridSize);
        InitializeShips();
    }

    protected override void OnParametersSet()
    {
        if (PlacementBoard.CurrentSize != GridSize)
        {
            PlacementBoard = new Board(GridSize);
            Placements.Clear();
            InitializeShips();
        }
    }

    private void InitializeShips()
    {
        RemainingShips = new List<ShipInfo>
        {
            new ShipInfo { Name = "Porte-avions", Size = 5, Type = ShipType.Carrier },
            new ShipInfo { Name = "Croiseur", Size = 4, Type = ShipType.Battleship },
            new ShipInfo { Name = "Contre-torpilleur", Size = 3, Type = ShipType.Cruiser },
            new ShipInfo { Name = "Sous-marin", Size = 3, Type = ShipType.Submarine },
            new ShipInfo { Name = "Torpilleur", Size = 2, Type = ShipType.Destroyer }
        };
        
        if (RemainingShips.Count > 0)
        {
            SelectedShipType = RemainingShips[0].Type;
        }
    }

    private void SelectShip(ShipInfo ship)
    {
        SelectedShipType = ship.Type;
        ErrorMessage = "";
        StateHasChanged();
    }

    private void ToggleOrientation()
    {
        IsHorizontal = !IsHorizontal;
        ErrorMessage = "";
        StateHasChanged();
    }

    private void HandleRightClick((int x, int y) position)
    {
        // Change l'orientation avec le clic droit
        IsHorizontal = !IsHorizontal;
        StateHasChanged();
    }

    private async Task ChangeSize(int size)
    {
        await OnGridSizeChanged.InvokeAsync(size);
    }

    private void ResetPlacements()
    {
        PlacementBoard = new Board();
        Placements.Clear();
        InitializeShips();
        ErrorMessage = "";
    }

    private void HoverCell(int x, int y)
    {
        HoverX = x;
        HoverY = y;
        StateHasChanged();
    }

    private void HandleCellHoverEvent((int x, int y) coords)
    {
        HoverCell(coords.x, coords.y);
    }

    private void ClearHover()
    {
        HoverX = -1;
        HoverY = -1;
        StateHasChanged();
    }

    private void PlaceShip(int x, int y)
    {
        if (!SelectedShipType.HasValue || RemainingShips.Count == 0)
        {
            ErrorMessage = "Sélectionnez un bateau à placer";
            return;
        }

        var currentShip = RemainingShips.First(s => s.Type == SelectedShipType.Value);
        
        if (!PlacementBoard.CanPlaceShip(x, y, currentShip.Size, IsHorizontal))
        {
            ErrorMessage = "Impossible de placer le bateau ici";
            return;
        }

        PlacementBoard.PlaceShip(x, y, currentShip.Size, IsHorizontal);
        
        Placements.Add(new ShipPlacement
        {
            X = x,
            Y = y,
            Size = currentShip.Size,
            IsHorizontal = IsHorizontal,
            ShipType = currentShip.Type
        });

        RemainingShips.RemoveAt(RemainingShips.FindIndex(s => s.Type == SelectedShipType.Value));
        
        if (RemainingShips.Count > 0)
        {
            SelectedShipType = RemainingShips[0].Type;
        }
        else
        {
            SelectedShipType = null;
        }

        ErrorMessage = "";
    }

    private async Task OnConfirmPlacement()
    {
        await OnPlacementsConfirmed.InvokeAsync(Placements);
    }

    private void HandlePlacementClick((int x, int y) coords)
    {
        PlaceShip(coords.x, coords.y);
    }

    private string GetPlacementCellClass(Cell cell)
    {
        var classes = new List<string> { "grid-cell" };
        
        if (cell.HasShip)
        {
            classes.Add("ship");
        }

        // Add hover class
        var hoverClass = GetHoverClass(cell.X, cell.Y);
        if (!string.IsNullOrEmpty(hoverClass))
        {
            classes.Add(hoverClass);
        }

        return string.Join(" ", classes);
    }

    private string GetHoverClass(int x, int y)
    {
        if (!SelectedShipType.HasValue || HoverX == -1 || HoverY == -1) return "";
        
        var selectedShip = RemainingShips.FirstOrDefault(s => s.Type == SelectedShipType.Value);
        if (selectedShip == null) return "";
        
        // Check if placement is valid at hover position
        bool canPlace = PlacementBoard.CanPlaceShip(HoverX, HoverY, selectedShip.Size, IsHorizontal);
        
        // Show hover preview for all cells the ship would occupy
        if (IsHorizontal)
        {
            // Horizontal: check if current cell is in the range [HoverX, HoverX + Size)
            if (y == HoverY && x >= HoverX && x < HoverX + selectedShip.Size)
            {
                return canPlace ? "hover-valid" : "hover-invalid";
            }
        }
        else
        {
            // Vertical: check if current cell is in the range [HoverY, HoverY + Size)
            if (x == HoverX && y >= HoverY && y < HoverY + selectedShip.Size)
            {
                return canPlace ? "hover-valid" : "hover-invalid";
            }
        }
        
        return "";
    }
}
